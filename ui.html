<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Base Styles */
      * {
        box-sizing: border-box;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s,
          opacity 0.2s, transform 0.2s;
        transition: background-color 0.1s, color 0.1s, border-color 0.2s,
          opacity 0.2s, transform 0.2s;
        transition-timing-function: ease;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
      }

      body {
        font-family: "Outfit", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        margin: 0;
        padding: 0;
        color: var(--text-color);
        background-color: var(--bg-color);
        font-size: 14px;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      /* Main Container */
      .container {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
      }

      /* Header Styles */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        padding-left: 10px;
        padding-right: 8px;
        padding-bottom: 0;
        border-bottom: 1.5px solid var(--border-color);
        background-color: var(--bg-color);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .header-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: var(--text-color);
        font-size: 16px;
      }

      .logo-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--primary-color);
        color: white;
        border-radius: var(--radius-sm);
      }

      .tabs {
        display: flex;
        gap: 6px;
        margin-left: 4px;
      }

      .tab {
        position: relative;
        padding: 9px 15px;
        color: var(--text-secondary);
        background-color: var(--bg-secondary);
        cursor: pointer;
        font-weight: 500;
        letter-spacing: 0.1px;
        font-size: 14px;
        border: none;
        display: flex;
        align-items: center;
        gap: 6px;
        border-top-left-radius: 14px;
        border-top-right-radius: 14px;
      }

      .tab:hover {
        color: var(--text-color);
        background-color: var(--primary-bg-hover);
        background-color: var(--overlay-hover);
      }

      .tab.active {
        color: var(--bg-secondary);
        color: #fcfcfc;
        background-color: var(--primary-color);
      }

      .tab svg {
        width: 16px;
        height: 16px;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Content Area */
      .content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      /* Button Styles */
      .icon-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: var(--radius-md);
        background-color: transparent;
        color: var(--text-secondary);
        border: none;
        cursor: pointer;
      }

      .icon-btn:hover {
        background-color: var(--overlay-hover);
        color: var(--text-color);
      }

      .icon-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Primary button */
      .primary-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 16px;
        /* background-color: var(--green-600); */
        background-color: var(--brown-700);
        color: white;
        color: #e8eee9;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 550;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        width: 100%;
        margin-top: -5px;
      }

      .primary-btn:active {
        transform: translateY(1px);
      }

      .primary-btn:disabled {
        background-color: var(--card-bg);
        color: var(--text-disabled);
        cursor: not-allowed;
      }

      /* Layer Info */
      .layer-info {
        display: flex;
        position: relative;
        align-items: center;
        gap: 12px;
        padding: 8px;
        padding-left: 12px;
        background-color: var(--bg-secondary);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        /* border-left: 3px solid var(--green-600); */
        border-left: 3px solid var(--brown-700);
      }

      .layer-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--primary-color);
        color: white;
        border-radius: var(--radius-sm);
        flex-shrink: 0;
      }

      .layer-details {
        flex: 1;
        overflow: hidden;
      }

      .layer-name {
        font-weight: 400;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-color);
        font-size: 15px;
        line-height: 120%;
      }

      .layer-type {
        color: var(--text-secondary);
        font-size: 12px;
      }

      .layer-details-icon {
        position: absolute;
        top: 8px;
        right: -3px;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 14px;
      }

      .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: var(--text-color);
        font-size: 13px;
      }

      .input-group {
        position: relative;
      }

      .input-field {
        width: 100%;
        padding: 10px 12px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 14px;
        color: var(--text-color);
        transition: border-color 0.2s;
      }

      .input-field:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .input-field::placeholder {
        color: var(--text-placeholder);
      }

      /* Search Input */
      .input-with-icon {
        padding-left: 36px;
      }

      .input-icon {
        position: absolute;
        top: 50%;
        left: 12px;
        transform: translateY(-50%);
        color: var(--text-secondary);
        pointer-events: none;
      }

      .input-icon svg {
        width: 16px;
        height: 16px;
      }

      /* Action buttons */
      .action-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 6px 10px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        color: var(--brown-700);
        font-size: 13px;
        cursor: pointer;
        font-weight: 500;
      }

      .action-btn:hover {
        background-color: var(--overlay-hover);
        border-color: var(--border-hover);
        color: var(--text-color);
      }

      .action-btn svg {
        width: 14px;
        height: 14px;
      }

      .danger-btn {
        color: var(--danger-color);
      }

      .danger-btn:hover {
        background-color: rgba(229, 62, 62, 0.1);
        color: var(--danger-hover);
      }

      .notes-field {
        min-height: 80px;
        min-height: 60px;
        resize: vertical;
        font-family: "Outfit", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
      }

      /* Tags */
      .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .tag {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px 4px 10px;
        background-color: var(--tag-bg);
        /* border: 1px solid var(--tag-border); */
        border-radius: var(--radius-full);
        color: var(--tag-color);
        font-size: 13px;
        font-weight: 400;
      }

      .tag-remove {
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: transparent;
      }

      .tag-remove:hover {
        background-color: rgba(0, 0, 0, 0.1);
      }

      .tag-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 150px;
        overflow-y: auto;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        z-index: 10;
        margin-top: 4px;
        display: none;
      }

      .tag-suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .tag-suggestion-item:hover {
        background-color: var(--overlay-hover);
      }

      .tag-count {
        font-size: 12px;
        color: var(--text-secondary);
        background-color: rgba(0, 0, 0, 0.05);
        padding: 2px 6px;
        border-radius: var(--radius-full);
      }

      /* Search Page */
      .search-page {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 16px 16px 0 16px; /* Remove bottom padding */
        overflow: hidden;
      }

      /* Filter tags */
      .filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 12px 0;
        margin-right: -4px;
        max-height: 75px;
        overflow-y: scroll;
        padding: 5px 0px;
      }

      .filter-tag {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        padding-bottom: 2px;
        background-color: var(--card-bg);
        background-color: var(--bg-secondary);
        /* border: 0.3px solid var(--border-color); */
        border-radius: var(--radius-full);
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
      }

      .filter-tag:hover {
        background-color: #759481aa;
        background-color: var(--brown-700);
        color: #e8eee9;
        color: var(--primary-bg-hover);
      }

      .filter-tag:hover .filter-count {
        color: #e8eee9;
        color: var(--primary-bg-hover);
      }

      .filter-tag.active {
        /* background-color: var(--green-600); */
        background-color: var(--brown-700);
        color: #e8eee9;
      }

      .filter-count {
        font-size: 10px;
        position: relative;
        top: -8px;
        margin-left: -2px;
        margin-bottom: -8px;
        border-radius: var(--radius-full);
        color: var(--text-secondary);
      }

      .filter-tag.active .filter-count {
        color: #e8eee9;
      }

      .search-results {
        flex: 1;
        overflow-x: hidden;
        overflow-y: auto;
        padding-bottom: 12px;
        margin-right: -4px;
        padding-right: 4px;
        max-height: 70%;
      }

      /* Search results */
      .search-status {
        margin-top: 16px;
        margin-bottom: 6px;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
      }

      .asterisk-list {
        display: flex;
        flex-direction: column;
      }

      .asterisk-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        padding-left: 4px;
        padding-right: 6px;
        background-color: var(--card-bg);
        background-color: var(--brown-100);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        border-left: none;
        border-right: none;
        cursor: pointer;
      }

      .asterisk-item:hover {
        border-color: var(--border-hover);
        background-color: var(--bg-secondary);
        background-color: var(--brown-150);
      }

      .asterisk-content {
        flex: 1;
        overflow: hidden;
      }

      .asterisk-name {
        font-weight: 600;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-left: 6px;
      }

      .asterisk-meta {
        color: var(--text-secondary);
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-left: 6px;
        margin-top: -2px;
      }

      .asterisk-url {
        color: var(--primary-color);
        color: var(--brown-750);
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-left: 6px;
        /* text-decoration: underline; */
        opacity: 09;
      }

      /* Asterisk tags */
      .asterisk-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
        margin-left: 2px;
      }

      .asterisk-tag {
        padding: 2px 6px;
        background-color: var(--card-bg);
        border-radius: var(--radius-full);
        /* color: var(--green-750); */
        color: var(--brown-600);
        color: var(--brown-750);
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.3px;
      }

      .asterisk-goto {
        margin-left: 8px;
      }

      /* Empty States */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px 16px;
        text-align: center;
        color: var(--text-secondary);
        height: 100%;
        margin-top: -50px;
      }

      .xempty-state-icon {
        margin-bottom: 8px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--card-bg);
        border-radius: var(--radius-md);
        color: var(--primary-color);
      }

      .empty-state-icon svg {
        width: 32px;
        height: 32px;
        margin-bottom: 8px;
      }

      .empty-state-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
        font-size: 15px;
      }

      .empty-state-text {
        font-size: 14px;
        max-width: 260px;
        line-height: 1.5;
      }

      /* Select Layer State */
      /* .select-layer {
                    padding: 12px 8px;
                    background-color: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: var(--radius-md);
                    color: var(--text-secondary);
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 8px;
                  }

                  .select-layer {
                    display: flex;
                  }

                  .select-layer-icon {
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: var(--primary-color);
                  }

                  .select-layer-text-small {
                    flex: 1;
                    font-size: 12px;
                    color: var(--text-secondary);
                  }

                  .select-layer-text {
                    flex: 1;
                    font-size: 15px;
                    color: var(--text-color);
                    line-height: 125%;
                  } */

      .select-layer {
        padding: 12px 8px;
        background-color: var(--bg-secondary);
        background-color: var(--primary-color);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        color: var(--bg-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }

      .select-layer {
        display: flex;
      }

      .select-layer-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        color: var(--bg-secondary);
      }

      .select-layer-text-small {
        flex: 1;
        font-size: 13px;
        color: var(--text-secondary);
        color: var(--bg-color);
        color: #e9e9e9;
      }

      .select-layer-text {
        flex: 1;
        font-size: 15px;
        color: var(--text-color);
        line-height: 125%;
        color: var(--bg-color);
        color: #fafafa;
        margin-top: -1px;
      }

      /* Welcome content */
      .welcome-content {
        /* margin-top: 16px; */
        margin: 0 auto;
        /* margin-top: -5px; */
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 12px;
        padding-bottom: 0;
        opacity: 0.85;
      }

      .welcome-icon {
        margin-bottom: 16px;
      }

      .welcome-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
      }

      .welcome-text {
        color: var(--text-secondary);
        margin-bottom: 24px;
        max-width: 280px;
      }

      .welcome-steps {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 24px;
      }

      .welcome-step {
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
        line-height: 115%;
      }

      .step-number {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: var(--card-bg);
        background-color: var(--brown-150);
        /* border: 0.4px solid var(--brown-700); */
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 13px;
        flex-shrink: 0;
      }

      .step-text {
        color: var(--text-secondary);
        font-size: 14px;
      }

      .welcome-tip {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 12px;
        background-color: var(--card-bg);
        background-color: var(--brown-150);
        border-radius: var(--radius-md);
        margin-top: 8px;
        max-width: 300px;
      }

      .tip-icon {
        color: var(--primary-color);
        margin-top: 2px;
      }

      .tip-text {
        color: var(--text-secondary);
        font-size: 13px;
        text-align: left;
        line-height: 1.4;
      }

      /* Status indicator */
      .status-indicator {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 6px;
        color: var(--text-secondary);
        font-size: 12px;
        font-weight: 500;
      }

      .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: var(--primary-color);
      }

      /* Form Actions */
      .form-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
      }

      .secondary-actions-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-secondary);
        font-size: 12px;
        font-weight: 500;
        margin-left: 4px;
      }

      .secondary-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      /* Settings Panel */
      .settings-panel {
        position: absolute;
        top: 45px;
        right: 5px;
        background-color: var(--bg-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        border: 0.1px solid var(--brown-500);
        width: 285px;
        max-height: calc(100vh - 80px);
        overflow-y: auto;
        z-index: 100;
        animation: fadeIn 0.2s;
        display: none;
      }

      .settings-panel-content {
        padding: 12px;
      }

      .settings-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0px;
        position: sticky;
        top: 0;
        background-color: var(--bg-color);
        padding: 5px 16px;
        padding-right: 5px;
        border-bottom: 1px solid var(--border-color);
        z-index: 1;
      }

      .settings-title {
        font-weight: 500;
        font-size: 15px;
      }

      .settings-option {
        margin-bottom: 24px;
      }

      .settings-option:last-child {
        margin-bottom: 0;
      }

      .settings-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 13px;
        color: var(--text-color);
      }

      .settings-description {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 6px;
        margin-top: -4px;
      }

      .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 3px 8px;
        border-radius: var(--radius-md);
        transition: background-color 0.2s;
      }

      .checkbox-label:hover {
        background-color: var(--overlay-hover);
      }

      .checkbox-text {
        font-size: 13px;
      }

      .checkbox-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        position: relative;
      }

      .icon-eye-open,
      .icon-eye-closed {
        position: absolute;
        transition: opacity 0.2s, transform 0.2s;
      }

      .icon-eye-open {
        color: var(--primary-color);
        opacity: 0;
        transform: scale(0.8);
      }

      .icon-eye-closed {
        color: var(--text-secondary);
        opacity: 1;
      }

      input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      input[type="checkbox"]:checked + .checkbox-icon .icon-eye-open {
        opacity: 1;
        transform: scale(1);
      }

      input[type="checkbox"]:checked + .checkbox-icon .icon-eye-closed {
        opacity: 0;
        transform: scale(0.8);
      }

      /* Focus state for accessibility */
      /* input[type="checkbox"]:focus + .checkbox-icon {
        outline: 2px solid var(--primary-color);
        border-radius: 50%;
      } */

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 36px;
        height: 20px;
        margin-left: 6px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        transition: 0.4s;
        border-radius: 34px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 2px;
        bottom: 2px;
        background-color: var(--text-secondary);
        background-color: var(--primary-color);
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .toggle-slider {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }

      input:checked + .toggle-slider:before {
        transform: translateX(16px);
        background-color: white;
      }

      .toggle-group {
        display: flex;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .toggle-option {
        flex: 1;
        text-align: center;
        padding: 6px 10px;
        font-size: 13px;
        cursor: pointer;
        background-color: var(--bg-color);
        color: var(--text-secondary);
        font-weight: 500;
        position: relative;
      }

      .toggle-option.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* Action option list for settings */
      .action-option-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }

      .action-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 6px 12px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
      }

      .action-option:hover {
        background-color: var(--bg-secondary);
        border-color: var(--border-hover);
      }

      .action-option.active {
        background-color: var(--bg-secondary);
        border-color: var(--primary-color);
      }

      .action-option-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--bg-color);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        color: #7f6f5d;
        flex-shrink: 0;
      }

      .action-option.active .action-option-icon {
        background-color: var(--primary-color);
        color: white;
      }

      .action-option-content {
        flex: 1;
      }

      .action-option-title {
        font-weight: 500;
        font-size: 14px;
        color: var(--text-color);
        margin-bottom: 2px;
      }

      .action-option-desc {
        font-size: 12px;
        line-height: 125%;
        color: var(--text-secondary);
      }

      .action-option-check {
        color: var(--primary-color);
        opacity: 0;
      }

      .action-option.active .action-option-check {
        opacity: 1;
      }

      /* Field order styling */
      .field-order-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 10px;
      }

      .field-order-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        cursor: grab;
      }

      .field-order-item.dragging {
        opacity: 0.6;
        cursor: grabbing;
      }

      .drag-handle {
        color: var(--text-secondary);
        cursor: grab;
        font-size: 12px;
        padding-right: 4px;
      }

      /* Notification */
      /* .notification {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        padding: 10px 16px;
        border-radius: var(--radius-full);
        font-size: 13px;
        font-weight: 500;
        box-shadow: var(--shadow-md);
        opacity: 0;
        transition: transform 0.3s, opacity 0.3s;
        z-index: 1000;
        background-color: var(--primary-color);
        color: white;
      } */

      .notification {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        padding: 8px 16px;
        border-radius: var(--radius-full);
        font-size: 13px;
        font-weight: 500;
        box-shadow: var(--shadow-md);
        opacity: 0;
        transition: transform 0.3s, opacity 0.3s;
        z-index: 1000;
        background-color: var(--primary-color);
        color: white;

        /* More flexible approach */
        min-width: 220px;
        max-width: 80%; /* Limits width to 80% of the container */
        width: auto; /* Allows the notification to size based on content */
        text-align: center; /* Centers the text */
        /* No white-space: nowrap to allow wrapping for longer messages */
      }

      .notification.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .notification.success {
        background-color: var(--primary-color);
      }

      .notification.warning {
        background-color: var(--danger-color);
      }

      .notification.info {
        background-color: #3182ce; /* Blue */
      }

      /* Tooltip styling */
      .tooltip {
        position: relative;
      }

      .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        top: 115%;
        top: -90%;
        left: 50%;
        transform: translateX(-50%);
        padding: 4px 8px;
        background-color: var(--text-color);
        color: white;
        border-radius: var(--radius-sm);
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 100;
      }

      .tooltip:hover::after {
        opacity: 1;
      }

      /* Ensure tooltip doesn't get cut off at the edge */
      .tooltip.tooltip-left::after {
        left: -30px;
        transform: translateX(0);
      }

      .tooltip.tooltip-right::after {
        left: auto;
        right: -10px;
        transform: translateX(0);
      }

      .action-buttons-container {
        display: flex;
        gap: 0px;
      }

      .asterisk-item:hover .action-buttons-container {
        opacity: 1;
      }

      .asterisk-item .action-buttons-container {
        opacity: 0.6;
        transition: opacity 0.2s;
      }

      .go-to-wrapper {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .go-to-text {
        opacity: 0;
        max-width: 0;
        overflow: hidden;
        white-space: nowrap;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: opacity 0.2s ease, max-width 0.3s ease;
      }

      .asterisk-item:hover .go-to-text {
        opacity: 1;
        max-width: 100px;
      }

      .asterisk-goto {
        margin-left: 0;
      }

      /* Loading spinner */
      .spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      /* Resize handle */
      .resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 24px;
        height: 24px;
        cursor: nwse-resize;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.4;
        transition: opacity 0.2s;
      }

      .resize-handle:hover {
        opacity: 0.8;
      }

      .resize-handle::before {
        content: "";
        width: 12px;
        height: 12px;
        display: block;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 1L1 11M11 5L5 11M11 9L9 11' stroke='%23666' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
      }

      /* Make sure the resize handle is more visible in dark mode */
      .dark-theme .resize-handle::before {
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 1L1 11M11 5L5 11M11 9L9 11' stroke='%23aaa' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      }

      /* Custom scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 4px;
        margin: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-color);
      }

      /* For Firefox */
      * {
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) transparent;
      }

      /* Make scrollbars in dark mode more visible */
      .dark-theme::-webkit-scrollbar-thumb {
        background: var(--text-secondary);
      }

      .dark-theme * {
        scrollbar-color: var(--text-secondary) transparent;
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateY(10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Add animation keyframes */
      @keyframes fadeSlideIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Improved animation keyframes for smoother transitions */
      @keyframes fadeSlideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Apply animation to the container instead of individual items */
      #asterisk-list {
        transition: opacity 0.2s ease-out;
      }

      /* Apply animation to each item with improved timing */
      .asterisk-item {
        animation: fadeSlideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        opacity: 0;
        backface-visibility: hidden; /* Prevent flickering in some browsers */
        will-change: transform, opacity; /* Performance optimization */
      }

      /* More subtle staggering for a smoother wave effect */
      .asterisk-item:nth-child(1) {
        animation-delay: 0.03s;
      }
      .asterisk-item:nth-child(2) {
        animation-delay: 0.06s;
      }
      .asterisk-item:nth-child(3) {
        animation-delay: 0.09s;
      }
      .asterisk-item:nth-child(4) {
        animation-delay: 0.12s;
      }
      .asterisk-item:nth-child(5) {
        animation-delay: 0.15s;
      }
      .asterisk-item:nth-child(6) {
        animation-delay: 0.18s;
      }
      .asterisk-item:nth-child(7) {
        animation-delay: 0.21s;
      }
      .asterisk-item:nth-child(8) {
        animation-delay: 0.24s;
      }
      .asterisk-item:nth-child(9) {
        animation-delay: 0.27s;
      }
      .asterisk-item:nth-child(10) {
        animation-delay: 0.3s;
      }

      /* Modern Design System Variables */
      :root {
        /* Core colors */
        --green-500: #60a5a9;
        --green-600: #759481;
        --green-700: #3a6f72;
        --green-750: #5f6862;
        --overlay-hover: rgba(0, 0, 0, 0.05);
        --danger-color: #e53e3e;
        --danger-hover: #c53030;

        /* Light theme - Green */
        /* --bg-color: #f4f7f4;
        --bg-secondary: #e8eee9;
        --card-bg: #f4f7f4;
        --text-color: #2c3436;
        --text-secondary: #6b7780;
        --text-placeholder: #a1a9b3;
        --text-disabled: #c4c9ce;
        --border-color: #e1e6e9;
        --border-hover: #d1d6d9;
        --primary-color: var(--green-600);
        --primary-hover: var(--green-700);
        --primary-bg: var(--green-500);
        --primary-bg-hover: var(--green-600);
        --tag-bg: #e8eee9;
        --input-bg: #ffffff;
        --shadow-sm: 0 1px 2px rgba(16, 24, 40, 0.05);
        --shadow-md: 0 2px 4px rgba(16, 24, 40, 0.05);
        --shadow-lg: 0 4px 8px rgba(16, 24, 40, 0.05);
        --radius-sm: 0px;
        --radius-md: 0px;
        --radius-lg: 0px;
        --radius-full: 9999px;
      } */

        --brown-500: #60a5a9;
        --brown-600: #e4d9cb;
        --brown-700: #7e6f5d;
        --brown-750: #5f4728;
        --brown-150: #e4d9cbb0;
        --brown-100: #f8f3ed;

        /* Light theme - Earth */
        /* --bg-color: #f5efe6b9; */
        --bg-color: var(--brown-100);
        /* --bg-secondary: #e8eee9; */
        --bg-secondary: var(--brown-600);
        --card-bg: #f5efe6;
        --text-color: #2c3436;
        --text-secondary: #6b7780;
        --text-placeholder: #a1a9b3;
        --text-disabled: #c4c9ce;
        --border-color: #e1e6e9;
        --border-hover: #d1d6d9;
        --primary-color: var(--brown-700);
        --primary-hover: var(--brown-750);
        --primary-bg: var(--brown-500);
        --primary-bg-hover: var(--brown-600);
        --tag-bg: var(--brown-600);
        --input-bg: #ffffff;
        --shadow-sm: 0 1px 2px rgba(16, 24, 40, 0.05);
        --shadow-md: 0 2px 4px rgba(16, 24, 40, 0.05);
        --shadow-lg: 0 4px 8px rgba(16, 24, 40, 0.05);
        --radius-sm: 0px;
        --radius-md: 0px;
        --radius-lg: 0px;
        --radius-full: 9999px;
      }

      /* Dark theme */
      .dark-theme {
        --bg-color: #0a0d10;
        --bg-secondary: #13171b;
        --card-bg: #1c2126;
        --text-color: #ffffff;
        --text-secondary: #adb5bd;
        --text-placeholder: #6c757d;
        --text-disabled: #495057;
        --border-color: #2a2f34;
        --border-hover: #3a3f44;
        --primary-color: var(--green-600);
        --primary-hover: var(--green-600);
        --primary-bg: var(--green-00);
        --primary-bg-hover: var(--green-700);
        --tag-bg: #2c3f40;
        /* --tag-color: #a7cfd1; */
        --tag-color: var(--green-600);
        --tag-border: #3e5859;
        --input-bg: #13171b;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.3);
        --danger-color: #fc8181;
        --danger-hover: #f56565;
      }

      /* Base Styles */
      * {
        box-sizing: border-box;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s,
          opacity 0.2s, transform 0.2s;
        transition: background-color 0.1s, color 0.1s, border-;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-left">
          <div class="tabs">
            <button class="tab active" data-tab="add">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M12 5v14M5 12h14"></path>
              </svg>
              Add Asterisk
            </button>
            <button class="tab" data-tab="search">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
              Search
            </button>
          </div>
        </div>
        <div class="header-right">
          <button id="settings-button" class="icon-btn tooltip">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="3"></circle>
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Add Asterisk Tab Content -->
      <div id="add-tab-content" class="content">
        <!-- Layer Info (shown when a layer is selected) -->
        <div id="layer-info" class="layer-info" style="display: none">
          <div class="layer-details">
            <div class="layer-type">Selected layer</div>
            <div id="layer-name" class="layer-name">Layer name</div>
          </div>
          <span class="layer-details-icon">
            <svg
              width="30"
              height="30"
              viewBox="0 0 20 20"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M9.07137 19.7287L8.82789 12.0348L2.54615 16.2713L0.306152 11.9374L7.41572 9.35654L1.52354 4.77915L4.98094 1.32176L9.55833 7.21393L12.1392 0.10437L16.5218 2.34437L12.2366 8.62611L19.9305 8.86959L19.1514 13.6905L11.7983 11.5478L13.9409 18.9496L9.07137 19.7287Z"
                fill="#F8F3ED"
              />
            </svg>
          </span>
        </div>

        <!-- Select Layer State (shown when no layer is selected) -->
        <div id="select-layer" class="select-layer">
          <div class="select-layer-icon">
            <svg
              width="22"
              height="22"
              viewBox="0 0 22 22"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g clip-path="url(#clip0_38_125)">
                <path
                  d="M9.07137 19.7287L8.82789 12.0348L2.54615 16.2713L0.306152 11.9374L7.41572 9.35654L1.52354 4.77915L4.98094 1.32176L9.55833 7.21393L12.1392 0.10437L16.5218 2.34437L12.2366 8.62611L19.9305 8.86959L19.1514 13.6905L11.7983 11.5478L13.9409 18.9496L9.07137 19.7287Z"
                  fill="#f4f7f4"
                />
              </g>
              <defs>
                <clipPath id="clip0_38_125">
                  <rect width="20" height="20" fill="white" />
                </clipPath>
              </defs>
            </svg>
          </div>
          <div class="layer-details">
            <div class="xlayer-type select-layer-text-small">Select layer</div>
            <div class="xlayer-name select-layer-text">
              Click on a layer to add or edit its note
            </div>
          </div>
        </div>

        <!-- Welcome content (shown when no layer is selected) -->
        <div id="welcome-content" class="welcome-content">
          <div class="welcome-icon">
            <svg
              width="40"
              height="40"
              viewBox="0 0 20 20"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M9.07137 19.7287L8.82789 12.0348L2.54615 16.2713L0.306152 11.9374L7.41572 9.35654L1.52354 4.77915L4.98094 1.32176L9.55833 7.21393L12.1392 0.10437L16.5218 2.34437L12.2366 8.62611L19.9305 8.86959L19.1514 13.6905L11.7983 11.5478L13.9409 18.9496L9.07137 19.7287Z"
                fill="#E4D9CB"
                opacity="0.8"
              />
            </svg>
          </div>
          <h3 class="welcome-title">Welcome to Asterisk</h3>
          <p class="welcome-text">
            Add context to your Figma elements with source links, tags, and
            notes
          </p>

          <div class="welcome-steps">
            <div class="welcome-step">
              <div class="step-number">1</div>
              <div class="step-text">Select any layer in your design</div>
            </div>
            <div class="welcome-step">
              <div class="step-number">2</div>
              <div class="step-text">Add relevant links, tags, and notes</div>
            </div>
            <div class="welcome-step">
              <div class="step-number">3</div>
              <div class="step-text">
                Find and filter your Asterisks in the Search tab
              </div>
            </div>
          </div>

          <div class="welcome-tip">
            <div class="tip-icon">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
            </div>
            <div class="tip-text">
              Tip: Use tags to organize and categorize your elements for easy
              lookup later
            </div>
          </div>
        </div>

        <!-- Form Container -->
        <div id="form-container" style="display: none">
          <!-- Form fields will be dynamically ordered based on user preferences -->
          <div id="source-url-group" class="form-group">
            <label class="form-label">Link to source</label>
            <div class="input-group">
              <input
                type="url"
                id="source-url"
                class="input-field"
                placeholder="Link to Unsplash / Pinterest / Design spec.."
              />
              <div class="action-buttons">
                <button
                  id="open-link-button"
                  class="action-btn"
                  style="display: none"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"
                    ></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                  Open link
                </button>
                <button
                  id="copy-link-button"
                  class="action-btn"
                  style="display: none"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="9"
                      y="9"
                      width="13"
                      height="13"
                      rx="2"
                      ry="2"
                    ></rect>
                    <path
                      d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                    ></path>
                  </svg>
                  Copy link
                </button>
              </div>
            </div>
          </div>

          <div id="tags-group" class="form-group">
            <label class="form-label">Add tags</label>
            <div class="input-group">
              <input
                type="text"
                id="tag-input"
                class="input-field"
                placeholder="moodboard / legacy design / revisit / draft"
              />
              <button
                id="add-tag-button"
                class="icon-btn"
                style="position: absolute; right: 4px; top: 4px"
              >
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="16"></line>
                  <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
              </button>
              <div id="tag-suggestions" class="tag-suggestions"></div>
            </div>
            <div id="tags-container" class="tags-container"></div>
          </div>

          <div id="notes-group" class="form-group">
            <label class="form-label">Notes</label>
            <textarea
              id="notes"
              class="input-field notes-field"
              placeholder="Add context, design decisions, feelings, usage guidelines..."
            ></textarea>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <!-- Primary button stays at the top -->
            <button id="save-button" class="primary-btn">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                ></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              Save note
            </button>

            <!-- Secondary row with status and actions -->
            <div class="secondary-actions-row">
              <!-- Auto-saved status on the left -->
              <div
                id="status-indicator"
                class="status-indicator"
                style="display: none"
              >
                <span class="status-dot"></span>
                <span>Auto saved</span>
              </div>

              <!-- Action buttons moved to right -->
              <div class="secondary-actions">
                <button id="go-to-layer-button" class="action-btn">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12 3L20 9L12 15C12 14.1 12 12.2 12 11.2727C8.88642 10.8644 5.70793 10.6258 3.07089 12.6385C2.96589 12.7278 2.86089 12.8171 2.75271 12.9091C2.51083 13.1116 2.51083 13.1116 2.26407 13.3182C1.47998 14 0.590213 15.8757 0.207254 17.4545C0.147254 17.4545 0.0872543 17.4545 0.0254361 17.4545C-0.122715 14.9401 0.354838 12.8414 2.02544 10.9091C4.65424 8.00332 8.23599 6.94357 12 6.54545C12 6.54545 12 3.90909 12 3Z"
                      fill="#7E6F5D"
                    />
                  </svg>
                  Go to layer
                </button>

                <button id="clear-button" class="action-btn danger-btn">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                  Clear
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Search Tab Content -->
      <div id="search-tab-content" class="search-page" style="display: none">
        <!-- Search Input -->
        <div class="input-group">
          <div class="input-icon">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </div>
          <input
            type="text"
            id="search-input"
            class="input-field input-with-icon"
            placeholder="Search Asterisks by tag, source, or note"
          />
        </div>

        <!-- Empty State for Search -->
        <div id="empty-search" class="empty-state" style="display: none">
          <!-- <div class="empty-state-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
              ></polygon>
            </svg>
          </div> -->

          <div class="empty-state-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M9.07137 19.7287L8.82789 12.0348L2.54615 16.2713L0.306152 11.9374L7.41572 9.35654L1.52354 4.77915L4.98094 1.32176L9.55833 7.21393L12.1392 0.10437L16.5218 2.34437L12.2366 8.62611L19.9305 8.86959L19.1514 13.6905L11.7983 11.5478L13.9409 18.9496L9.07137 19.7287Z"
                fill="#E4D9CB"
                opacity="0.8"
              />
            </svg>
          </div>
          <div class="empty-state-title">No Asterisks yet</div>
          <div class="empty-state-text">
            Select any layer and add an Asterisk to start building your
            collection!
          </div>
        </div>

        <!-- Search Content (shown when elements exist) -->
        <div id="search-content">
          <!-- Filter Tags -->
          <div id="filter-tags" class="filter-tags"></div>

          <!-- Search Status -->
          <div id="search-status" class="search-status">
            Showing all Asterisks
          </div>

          <!-- Search Results -->
          <div class="search-results">
            <div id="asterisk-list" class="asterisk-list"></div>
          </div>
        </div>
      </div>

      <!-- Settings Panel -->
      <div id="settings-panel" class="settings-panel">
        <div class="settings-header">
          <div class="settings-title">Settings</div>
          <button id="close-settings" class="icon-btn">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <div class="settings-panel-content">
          <div class="settings-option">
            <label class="settings-label">Customize Asterisk form layout</label>
            <div class="field-order-container">
              <div
                class="field-order-item"
                draggable="true"
                data-field="sourceUrl"
              >
                <span class="drag-handle">⋮⋮</span>
                <span>Source URL</span>
              </div>
              <div class="field-order-item" draggable="true" data-field="tags">
                <span class="drag-handle">⋮⋮</span>
                <span>Tags</span>
              </div>
              <div class="field-order-item" draggable="true" data-field="notes">
                <span class="drag-handle">⋮⋮</span>
                <span>Notes</span>
              </div>
            </div>
          </div>

          <div class="settings-option">
            <label class="settings-label">When clicking a search result</label>

            <div class="action-option-list">
              <div
                class="action-option search-action-option active"
                data-value="navigate"
              >
                <div class="action-option-icon">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12 3L20 9L12 15C12 14.1 12 12.2 12 11.2727C8.88642 10.8644 5.70793 10.6258 3.07089 12.6385C2.96589 12.7278 2.86089 12.8171 2.75271 12.9091C2.51083 13.1116 2.51083 13.1116 2.26407 13.3182C1.47998 14 0.590213 15.8757 0.207254 17.4545C0.147254 17.4545 0.0872543 17.4545 0.0254361 17.4545C-0.122715 14.9401 0.354838 12.8414 2.02544 10.9091C4.65424 8.00332 8.23599 6.94357 12 6.54545C12 6.54545 12 3.90909 12 3Z"
                      fill="currentColor"
                    />
                  </svg>
                </div>
                <div class="action-option-content">
                  <div class="action-option-title">Navigate to layer</div>
                  <div class="action-option-desc">
                    Jump directly to the layer in your design
                  </div>
                </div>
                <div class="action-option-check">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </div>
              </div>

              <div class="action-option search-action-option" data-value="open">
                <div class="action-option-icon">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 20 20"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M9.07137 19.7287L8.82789 12.0348L2.54615 16.2713L0.306152 11.9374L7.41572 9.35654L1.52354 4.77915L4.98094 1.32176L9.55833 7.21393L12.1392 0.10437L16.5218 2.34437L12.2366 8.62611L19.9305 8.86959L19.1514 13.6905L11.7983 11.5478L13.9409 18.9496L9.07137 19.7287Z"
                      fill="currentColor"
                    />
                  </svg>
                </div>
                <div class="action-option-content">
                  <div class="action-option-title">Open Asterisk</div>
                  <div class="action-option-desc">
                    View and edit the Asterisk details
                  </div>
                </div>
                <div class="action-option-check">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-option">
            <label class="settings-label">Search result fields</label>
            <p class="settings-description">
              Choose which details appear in results (search will still check
              all fields)
            </p>

            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="show-name-field" checked />
                <span class="checkbox-icon">
                  <svg
                    class="icon-eye-open"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                    ></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>

                  <svg
                    width="14"
                    height="14"
                    class="icon-eye-closed"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M21.8811 16.663C21.7954 16.7118 21.7009 16.7433 21.6031 16.7556C21.5053 16.7679 21.4059 16.7608 21.3109 16.7347C21.2158 16.7085 21.1268 16.6639 21.0489 16.6034C20.9711 16.5428 20.906 16.4675 20.8573 16.3817L19.0761 13.2692C18.0405 13.9694 16.8981 14.4969 15.6936 14.8311L16.2439 18.133C16.2601 18.2302 16.257 18.3296 16.2348 18.4256C16.2126 18.5217 16.1717 18.6124 16.1144 18.6925C16.0571 18.7727 15.9846 18.8408 15.9009 18.893C15.8173 18.9451 15.7242 18.9803 15.627 18.9964C15.587 19.003 15.5466 19.0064 15.5061 19.0067C15.3286 19.0065 15.157 18.9433 15.0218 18.8285C14.8865 18.7136 14.7964 18.5546 14.7673 18.3795L14.2264 15.1377C13.0856 15.2964 11.9284 15.2964 10.7876 15.1377L10.2467 18.3795C10.2176 18.5549 10.1271 18.7142 9.99149 18.8291C9.85584 18.9439 9.68381 19.0069 9.50606 19.0067C9.4646 19.0066 9.42322 19.0031 9.38231 18.9964C9.28509 18.9803 9.192 18.9451 9.10837 18.893C9.02475 18.8408 8.95222 18.7727 8.89493 18.6925C8.83764 18.6124 8.79671 18.5217 8.77449 18.4256C8.75227 18.3296 8.74919 18.2302 8.76543 18.133L9.31856 14.8311C8.11446 14.4959 6.97274 13.9674 5.93793 13.2664L4.16231 16.3817C4.06285 16.555 3.89862 16.6817 3.70575 16.7339C3.51288 16.7862 3.30717 16.7596 3.13387 16.6602C2.96057 16.5607 2.83387 16.3965 2.78165 16.2036C2.72944 16.0107 2.75597 15.805 2.85543 15.6317L4.73043 12.3505C4.07184 11.7815 3.46623 11.1539 2.92106 10.4755C2.85307 10.3996 2.80126 10.3106 2.7688 10.214C2.73634 10.1174 2.72391 10.0152 2.73226 9.91364C2.74061 9.81208 2.76957 9.71328 2.81738 9.62328C2.86518 9.53328 2.93082 9.45397 3.0103 9.39019C3.08978 9.3264 3.18142 9.27948 3.27963 9.25229C3.37784 9.2251 3.48056 9.21821 3.58153 9.23204C3.68249 9.24587 3.77958 9.28014 3.86686 9.33274C3.95414 9.38534 4.02979 9.45517 4.08918 9.53798C5.64543 11.4636 8.36793 13.7567 12.5061 13.7567C16.6442 13.7567 19.3667 11.4608 20.9229 9.53798C20.9816 9.45348 21.0571 9.38196 21.1447 9.32788C21.2322 9.2738 21.3299 9.23831 21.4318 9.22362C21.5336 9.20893 21.6374 9.21536 21.7367 9.2425C21.8359 9.26965 21.9285 9.31692 22.0087 9.38139C22.0889 9.44586 22.155 9.52615 22.2029 9.61725C22.2507 9.70835 22.2793 9.80832 22.2868 9.91095C22.2944 10.0136 22.2807 10.1166 22.2467 10.2138C22.2127 10.3109 22.1591 10.4 22.0892 10.4755C21.544 11.1539 20.9384 11.7815 20.2798 12.3505L22.1548 15.6317C22.2051 15.7173 22.238 15.8119 22.2515 15.9103C22.2649 16.0086 22.2588 16.1086 22.2333 16.2045C22.2079 16.3005 22.1636 16.3904 22.1031 16.4691C22.0427 16.5478 21.9672 16.6137 21.8811 16.663Z"
                      fill="black"
                    />
                  </svg>
                </span>
                <span class="checkbox-text">Layer name</span>
              </label>

              <label class="checkbox-label">
                <input type="checkbox" id="show-notes-field" checked />
                <span class="checkbox-icon">
                  <svg
                    class="icon-eye-open"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                    ></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>

                  <svg
                    width="14"
                    height="14"
                    class="icon-eye-closed"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M21.8811 16.663C21.7954 16.7118 21.7009 16.7433 21.6031 16.7556C21.5053 16.7679 21.4059 16.7608 21.3109 16.7347C21.2158 16.7085 21.1268 16.6639 21.0489 16.6034C20.9711 16.5428 20.906 16.4675 20.8573 16.3817L19.0761 13.2692C18.0405 13.9694 16.8981 14.4969 15.6936 14.8311L16.2439 18.133C16.2601 18.2302 16.257 18.3296 16.2348 18.4256C16.2126 18.5217 16.1717 18.6124 16.1144 18.6925C16.0571 18.7727 15.9846 18.8408 15.9009 18.893C15.8173 18.9451 15.7242 18.9803 15.627 18.9964C15.587 19.003 15.5466 19.0064 15.5061 19.0067C15.3286 19.0065 15.157 18.9433 15.0218 18.8285C14.8865 18.7136 14.7964 18.5546 14.7673 18.3795L14.2264 15.1377C13.0856 15.2964 11.9284 15.2964 10.7876 15.1377L10.2467 18.3795C10.2176 18.5549 10.1271 18.7142 9.99149 18.8291C9.85584 18.9439 9.68381 19.0069 9.50606 19.0067C9.4646 19.0066 9.42322 19.0031 9.38231 18.9964C9.28509 18.9803 9.192 18.9451 9.10837 18.893C9.02475 18.8408 8.95222 18.7727 8.89493 18.6925C8.83764 18.6124 8.79671 18.5217 8.77449 18.4256C8.75227 18.3296 8.74919 18.2302 8.76543 18.133L9.31856 14.8311C8.11446 14.4959 6.97274 13.9674 5.93793 13.2664L4.16231 16.3817C4.06285 16.555 3.89862 16.6817 3.70575 16.7339C3.51288 16.7862 3.30717 16.7596 3.13387 16.6602C2.96057 16.5607 2.83387 16.3965 2.78165 16.2036C2.72944 16.0107 2.75597 15.805 2.85543 15.6317L4.73043 12.3505C4.07184 11.7815 3.46623 11.1539 2.92106 10.4755C2.85307 10.3996 2.80126 10.3106 2.7688 10.214C2.73634 10.1174 2.72391 10.0152 2.73226 9.91364C2.74061 9.81208 2.76957 9.71328 2.81738 9.62328C2.86518 9.53328 2.93082 9.45397 3.0103 9.39019C3.08978 9.3264 3.18142 9.27948 3.27963 9.25229C3.37784 9.2251 3.48056 9.21821 3.58153 9.23204C3.68249 9.24587 3.77958 9.28014 3.86686 9.33274C3.95414 9.38534 4.02979 9.45517 4.08918 9.53798C5.64543 11.4636 8.36793 13.7567 12.5061 13.7567C16.6442 13.7567 19.3667 11.4608 20.9229 9.53798C20.9816 9.45348 21.0571 9.38196 21.1447 9.32788C21.2322 9.2738 21.3299 9.23831 21.4318 9.22362C21.5336 9.20893 21.6374 9.21536 21.7367 9.2425C21.8359 9.26965 21.9285 9.31692 22.0087 9.38139C22.0889 9.44586 22.155 9.52615 22.2029 9.61725C22.2507 9.70835 22.2793 9.80832 22.2868 9.91095C22.2944 10.0136 22.2807 10.1166 22.2467 10.2138C22.2127 10.3109 22.1591 10.4 22.0892 10.4755C21.544 11.1539 20.9384 11.7815 20.2798 12.3505L22.1548 15.6317C22.2051 15.7173 22.238 15.8119 22.2515 15.9103C22.2649 16.0086 22.2588 16.1086 22.2333 16.2045C22.2079 16.3005 22.1636 16.3904 22.1031 16.4691C22.0427 16.5478 21.9672 16.6137 21.8811 16.663Z"
                      fill="black"
                    />
                  </svg>
                </span>
                <span class="checkbox-text">Notes</span>
              </label>

              <label class="checkbox-label">
                <input type="checkbox" id="show-url-field" />
                <span class="checkbox-icon">
                  <svg
                    class="icon-eye-open"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                    ></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>

                  <svg
                    width="14"
                    height="14"
                    class="icon-eye-closed"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M21.8811 16.663C21.7954 16.7118 21.7009 16.7433 21.6031 16.7556C21.5053 16.7679 21.4059 16.7608 21.3109 16.7347C21.2158 16.7085 21.1268 16.6639 21.0489 16.6034C20.9711 16.5428 20.906 16.4675 20.8573 16.3817L19.0761 13.2692C18.0405 13.9694 16.8981 14.4969 15.6936 14.8311L16.2439 18.133C16.2601 18.2302 16.257 18.3296 16.2348 18.4256C16.2126 18.5217 16.1717 18.6124 16.1144 18.6925C16.0571 18.7727 15.9846 18.8408 15.9009 18.893C15.8173 18.9451 15.7242 18.9803 15.627 18.9964C15.587 19.003 15.5466 19.0064 15.5061 19.0067C15.3286 19.0065 15.157 18.9433 15.0218 18.8285C14.8865 18.7136 14.7964 18.5546 14.7673 18.3795L14.2264 15.1377C13.0856 15.2964 11.9284 15.2964 10.7876 15.1377L10.2467 18.3795C10.2176 18.5549 10.1271 18.7142 9.99149 18.8291C9.85584 18.9439 9.68381 19.0069 9.50606 19.0067C9.4646 19.0066 9.42322 19.0031 9.38231 18.9964C9.28509 18.9803 9.192 18.9451 9.10837 18.893C9.02475 18.8408 8.95222 18.7727 8.89493 18.6925C8.83764 18.6124 8.79671 18.5217 8.77449 18.4256C8.75227 18.3296 8.74919 18.2302 8.76543 18.133L9.31856 14.8311C8.11446 14.4959 6.97274 13.9674 5.93793 13.2664L4.16231 16.3817C4.06285 16.555 3.89862 16.6817 3.70575 16.7339C3.51288 16.7862 3.30717 16.7596 3.13387 16.6602C2.96057 16.5607 2.83387 16.3965 2.78165 16.2036C2.72944 16.0107 2.75597 15.805 2.85543 15.6317L4.73043 12.3505C4.07184 11.7815 3.46623 11.1539 2.92106 10.4755C2.85307 10.3996 2.80126 10.3106 2.7688 10.214C2.73634 10.1174 2.72391 10.0152 2.73226 9.91364C2.74061 9.81208 2.76957 9.71328 2.81738 9.62328C2.86518 9.53328 2.93082 9.45397 3.0103 9.39019C3.08978 9.3264 3.18142 9.27948 3.27963 9.25229C3.37784 9.2251 3.48056 9.21821 3.58153 9.23204C3.68249 9.24587 3.77958 9.28014 3.86686 9.33274C3.95414 9.38534 4.02979 9.45517 4.08918 9.53798C5.64543 11.4636 8.36793 13.7567 12.5061 13.7567C16.6442 13.7567 19.3667 11.4608 20.9229 9.53798C20.9816 9.45348 21.0571 9.38196 21.1447 9.32788C21.2322 9.2738 21.3299 9.23831 21.4318 9.22362C21.5336 9.20893 21.6374 9.21536 21.7367 9.2425C21.8359 9.26965 21.9285 9.31692 22.0087 9.38139C22.0889 9.44586 22.155 9.52615 22.2029 9.61725C22.2507 9.70835 22.2793 9.80832 22.2868 9.91095C22.2944 10.0136 22.2807 10.1166 22.2467 10.2138C22.2127 10.3109 22.1591 10.4 22.0892 10.4755C21.544 11.1539 20.9384 11.7815 20.2798 12.3505L22.1548 15.6317C22.2051 15.7173 22.238 15.8119 22.2515 15.9103C22.2649 16.0086 22.2588 16.1086 22.2333 16.2045C22.2079 16.3005 22.1636 16.3904 22.1031 16.4691C22.0427 16.5478 21.9672 16.6137 21.8811 16.663Z"
                      fill="black"
                    />
                  </svg>
                </span>
                <span class="checkbox-text">Source URL</span>
              </label>

              <label class="checkbox-label">
                <input type="checkbox" id="show-tags-field" checked />
                <span class="checkbox-icon">
                  <svg
                    class="icon-eye-open"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                    ></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>

                  <svg
                    width="14"
                    height="14"
                    class="icon-eye-closed"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M21.8811 16.663C21.7954 16.7118 21.7009 16.7433 21.6031 16.7556C21.5053 16.7679 21.4059 16.7608 21.3109 16.7347C21.2158 16.7085 21.1268 16.6639 21.0489 16.6034C20.9711 16.5428 20.906 16.4675 20.8573 16.3817L19.0761 13.2692C18.0405 13.9694 16.8981 14.4969 15.6936 14.8311L16.2439 18.133C16.2601 18.2302 16.257 18.3296 16.2348 18.4256C16.2126 18.5217 16.1717 18.6124 16.1144 18.6925C16.0571 18.7727 15.9846 18.8408 15.9009 18.893C15.8173 18.9451 15.7242 18.9803 15.627 18.9964C15.587 19.003 15.5466 19.0064 15.5061 19.0067C15.3286 19.0065 15.157 18.9433 15.0218 18.8285C14.8865 18.7136 14.7964 18.5546 14.7673 18.3795L14.2264 15.1377C13.0856 15.2964 11.9284 15.2964 10.7876 15.1377L10.2467 18.3795C10.2176 18.5549 10.1271 18.7142 9.99149 18.8291C9.85584 18.9439 9.68381 19.0069 9.50606 19.0067C9.4646 19.0066 9.42322 19.0031 9.38231 18.9964C9.28509 18.9803 9.192 18.9451 9.10837 18.893C9.02475 18.8408 8.95222 18.7727 8.89493 18.6925C8.83764 18.6124 8.79671 18.5217 8.77449 18.4256C8.75227 18.3296 8.74919 18.2302 8.76543 18.133L9.31856 14.8311C8.11446 14.4959 6.97274 13.9674 5.93793 13.2664L4.16231 16.3817C4.06285 16.555 3.89862 16.6817 3.70575 16.7339C3.51288 16.7862 3.30717 16.7596 3.13387 16.6602C2.96057 16.5607 2.83387 16.3965 2.78165 16.2036C2.72944 16.0107 2.75597 15.805 2.85543 15.6317L4.73043 12.3505C4.07184 11.7815 3.46623 11.1539 2.92106 10.4755C2.85307 10.3996 2.80126 10.3106 2.7688 10.214C2.73634 10.1174 2.72391 10.0152 2.73226 9.91364C2.74061 9.81208 2.76957 9.71328 2.81738 9.62328C2.86518 9.53328 2.93082 9.45397 3.0103 9.39019C3.08978 9.3264 3.18142 9.27948 3.27963 9.25229C3.37784 9.2251 3.48056 9.21821 3.58153 9.23204C3.68249 9.24587 3.77958 9.28014 3.86686 9.33274C3.95414 9.38534 4.02979 9.45517 4.08918 9.53798C5.64543 11.4636 8.36793 13.7567 12.5061 13.7567C16.6442 13.7567 19.3667 11.4608 20.9229 9.53798C20.9816 9.45348 21.0571 9.38196 21.1447 9.32788C21.2322 9.2738 21.3299 9.23831 21.4318 9.22362C21.5336 9.20893 21.6374 9.21536 21.7367 9.2425C21.8359 9.26965 21.9285 9.31692 22.0087 9.38139C22.0889 9.44586 22.155 9.52615 22.2029 9.61725C22.2507 9.70835 22.2793 9.80832 22.2868 9.91095C22.2944 10.0136 22.2807 10.1166 22.2467 10.2138C22.2127 10.3109 22.1591 10.4 22.0892 10.4755C21.544 11.1539 20.9384 11.7815 20.2798 12.3505L22.1548 15.6317C22.2051 15.7173 22.238 15.8119 22.2515 15.9103C22.2649 16.0086 22.2588 16.1086 22.2333 16.2045C22.2079 16.3005 22.1636 16.3904 22.1031 16.4691C22.0427 16.5478 21.9672 16.6137 21.8811 16.663Z"
                      fill="black"
                    />
                  </svg>
                </span>
                <span class="checkbox-text">Tags</span>
              </label>
            </div>
          </div>

          <div class="settings-option">
            <label class="settings-label">Auto-save notes</label>
            <label class="toggle-switch">
              <input type="checkbox" id="autosave-toggle" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>

      <!-- Notification -->
      <div id="notification" class="notification"></div>
      <div id="resize-handle" class="resize-handle"></div>
    </div>
    <script>
      // Global state
      let currentContext = {
        fileKey: null,
        pageId: null,
        pageName: null,
      };
      let currentFileContext = {
        fileKey: null,
        pageId: null,
        pageName: null,
        timestamp: 0,
      };
      let currentTags = [];
      let currentNodeName = "";
      let currentNodeId = "";
      let preferences = {
        theme: "light",
        autosave: true,
        defaultSearchAction: "navigate",
        fieldOrder: ["sourceUrl", "tags", "notes"],
        searchFields: {
          showName: true, // Always true, can't be disabled
          showNotes: true,
          showTags: true,
          showUrl: false,
        },
      };
      let autosaveTimer = null;
      let allTags = []; // For tag suggestions with counts
      let allElements = []; // For search tab
      let activeTab = "add"; // "add" or "search"
      let activeFilterTags = []; // For filtering elements in search tab

      document.addEventListener("DOMContentLoaded", function () {
        // Initialize
        parent.postMessage({ pluginMessage: { type: "get-metadata" } }, "*");
        parent.postMessage({ pluginMessage: { type: "get-all-tags" } }, "*");
        parent.postMessage(
          { pluginMessage: { type: "get-all-elements" } },
          "*"
        );

        // Tab switching
        setupTabSwitching();

        // Settings panel
        setupSettingsPanel();

        // Tag input handling
        setupTagInput();

        // URL field handling
        setupUrlField();

        // Form actions
        setupFormActions();

        // Listen for messages from the plugin
        setupPluginMessageListener();

        // Setup resize handle
        setupResizeHandle();

        // Setup keyboard shortcuts
        setupKeyboardShortcuts();
      });

      // Tab switching functionality
      function setupTabSwitching() {
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            const tabName = this.dataset.tab;
            switchTab(tabName);
          });
        });
      }

      // function switchTab(tabName) {
      //   activeTab = tabName;

      //   // Update tab buttons
      //   document.querySelectorAll(".tab").forEach((tab) => {
      //     tab.classList.remove("active");
      //     if (tab.dataset.tab === tabName) {
      //       tab.classList.add("active");
      //     }
      //   });

      //   // Show/hide content based on active tab
      //   if (tabName === "add") {
      //     document.getElementById("add-tab-content").style.display = "block";
      //     document.getElementById("search-tab-content").style.display = "none";
      //   } else if (tabName === "search") {
      //     document.getElementById("add-tab-content").style.display = "none";
      //     document.getElementById("search-tab-content").style.display = "block";

      //     // Refresh elements list when switching to search tab
      //     parent.postMessage(
      //       { pluginMessage: { type: "get-all-elements" } },
      //       "*"
      //     );
      //     parent.postMessage({ pluginMessage: { type: "get-all-tags" } }, "*");

      //     // Make sure the search results are displayed
      //     setTimeout(() => {
      //       renderElementsList();
      //       toggleEmptySearch();
      //     }, 100);
      //   }
      // }

      // function switchTab(tabName) {
      //   activeTab = tabName;

      //   // Update tab buttons
      //   document.querySelectorAll(".tab").forEach((tab) => {
      //     tab.classList.remove("active");
      //     if (tab.dataset.tab === tabName) {
      //       tab.classList.add("active");
      //     }
      //   });

      //   // Show/hide content based on active tab
      //   if (tabName === "add") {
      //     document.getElementById("add-tab-content").style.display = "block";
      //     document.getElementById("search-tab-content").style.display = "none";
      //   } else if (tabName === "search") {
      //     document.getElementById("add-tab-content").style.display = "none";
      //     document.getElementById("search-tab-content").style.display = "block";

      //     // Refresh elements list when switching to search tab
      //     parent.postMessage(
      //       { pluginMessage: { type: "get-all-elements" } },
      //       "*"
      //     );
      //     parent.postMessage({ pluginMessage: { type: "get-all-tags" } }, "*");

      //     // After the messages are processed, make sure to apply the active filters
      //     setTimeout(() => {
      //       renderElementsList();
      //       filterElements(); // Apply the active filters immediately
      //       toggleEmptySearch();

      //       // Update the UI to show which filter tags are active
      //       document.querySelectorAll(".filter-tag").forEach((tag) => {
      //         const tagName = tag.querySelector("span").textContent;
      //         if (activeFilterTags.includes(tagName)) {
      //           tag.classList.add("active");
      //         } else {
      //           tag.classList.remove("active");
      //         }
      //       });
      //     }, 100);
      //   }
      // }

      function switchTab(tabName) {
        activeTab = tabName;

        // Update tab buttons
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
          if (tab.dataset.tab === tabName) {
            tab.classList.add("active");
          }
        });

        // Show/hide content based on active tab
        if (tabName === "add") {
          document.getElementById("add-tab-content").style.display = "block";
          document.getElementById("search-tab-content").style.display = "none";
        } else if (tabName === "search") {
          document.getElementById("add-tab-content").style.display = "none";
          document.getElementById("search-tab-content").style.display = "block";

          // Reset active filters
          activeFilterTags = [];

          // Clear all previously loaded tags and elements
          allTags = [];
          allElements = [];
          updateFilterTags();

          // Request fresh data for current file context
          console.log(
            `[STRICT] Requesting fresh data for file="${currentFileContext.fileKey}", page="${currentFileContext.pageName}"`
          );

          // Show loading state
          document.getElementById(
            "asterisk-list"
          ).innerHTML = `<div style="text-align: center; padding: 20px;">Loading data for "${currentFileContext.pageName}"...</div>`;

          // Request fresh data
          parent.postMessage(
            { pluginMessage: { type: "get-all-elements" } },
            "*"
          );
          parent.postMessage({ pluginMessage: { type: "get-all-tags" } }, "*");
        }
      }

      // Settings panel functionality
      function setupSettingsPanel() {
        // Toggle settings panel visibility
        document
          .getElementById("settings-button")
          .addEventListener("click", function () {
            const panel = document.getElementById("settings-panel");
            panel.style.display =
              panel.style.display === "block" ? "none" : "block";
          });

        // Close settings panel
        document
          .getElementById("close-settings")
          .addEventListener("click", function () {
            document.getElementById("settings-panel").style.display = "none";
          });

        // Theme toggling
        document.querySelectorAll(".theme-option").forEach((option) => {
          option.addEventListener("click", function () {
            const theme = this.dataset.value;
            updateTheme(theme);

            // Update UI
            document.querySelectorAll(".theme-option").forEach((opt) => {
              opt.classList.remove("active");
            });
            this.classList.add("active");

            // Update preferences
            preferences.theme = theme;
            savePreferences();
          });
        });

        // Autosave toggle
        document
          .getElementById("autosave-toggle")
          .addEventListener("change", function () {
            preferences.autosave = this.checked;
            updateAutosave();
            savePreferences();
          });

        // Default search action toggle
        document.querySelectorAll(".search-action-option").forEach((option) => {
          option.addEventListener("click", function () {
            const action = this.dataset.value;

            // Update UI
            document
              .querySelectorAll(".search-action-option")
              .forEach((opt) => {
                opt.classList.remove("active");
              });
            this.classList.add("active");

            // Update preferences
            preferences.defaultSearchAction = action;
            savePreferences();
          });
        });

        // Setup search field visibility options
        document
          .getElementById("show-name-field")
          .addEventListener("change", function () {
            preferences.searchFields.showName = this.checked;
            savePreferences();
            if (activeTab === "search") {
              renderElementsList(); // Re-render if we're on search tab
            }
          });

        document
          .getElementById("show-notes-field")
          .addEventListener("change", function () {
            preferences.searchFields.showNotes = this.checked;
            savePreferences();
            if (activeTab === "search") {
              renderElementsList(); // Re-render if we're on search tab
            }
          });

        document
          .getElementById("show-tags-field")
          .addEventListener("change", function () {
            preferences.searchFields.showTags = this.checked;
            savePreferences();
            if (activeTab === "search") {
              renderElementsList();
            }
          });

        document
          .getElementById("show-url-field")
          .addEventListener("change", function () {
            preferences.searchFields.showUrl = this.checked;
            savePreferences();
            if (activeTab === "search") {
              renderElementsList();
            }
          });

        // Handle clicks outside settings panel
        document.addEventListener("click", function (event) {
          const panel = document.getElementById("settings-panel");
          const settingsButton = document.getElementById("settings-button");

          if (
            panel.style.display === "block" &&
            !panel.contains(event.target) &&
            event.target !== settingsButton &&
            !settingsButton.contains(event.target)
          ) {
            panel.style.display = "none";
          }
        });
      }

      // Field order drag and drop functionality
      function setupFieldOrderDragAndDrop() {
        const items = document.querySelectorAll(".field-order-item");
        let draggedItem = null;

        items.forEach((item) => {
          // Make draggable
          item.addEventListener("dragstart", function () {
            draggedItem = this;
            this.classList.add("dragging");
          });

          item.addEventListener("dragend", function () {
            this.classList.remove("dragging");

            // Save new order to preferences
            const newOrder = Array.from(
              document.querySelectorAll(".field-order-item")
            )
              .sort((a, b) => parseInt(a.style.order) - parseInt(b.style.order))
              .map((item) => item.dataset.field);

            preferences.fieldOrder = newOrder;
            savePreferences();

            // Apply the new field order to the form
            applyFieldOrder();
          });

          item.addEventListener("dragover", function (e) {
            e.preventDefault();
          });

          item.addEventListener("drop", function (e) {
            e.preventDefault();

            // Swap the order of the items
            const draggedOrder = draggedItem.style.order;
            draggedItem.style.order = this.style.order;
            this.style.order = draggedOrder;
          });
        });
      }

      // Initialize field order based on preferences
      function initializeFieldOrder() {
        const items = document.querySelectorAll(".field-order-item");

        items.forEach((item) => {
          // Set initial order based on preferences
          const fieldIndex = preferences.fieldOrder.indexOf(item.dataset.field);
          item.style.order = fieldIndex + 1;
        });

        // Apply the field order to the form
        applyFieldOrder();
      }

      // Function to apply field order to the form
      function applyFieldOrder() {
        const formContainer = document.getElementById("form-container");
        if (!formContainer) return;

        const sourceUrlGroup = document.getElementById("source-url-group");
        const tagsGroup = document.getElementById("tags-group");
        const notesGroup = document.getElementById("notes-group");

        // Store references to the action buttons
        const formActions = document.querySelector(".form-actions");
        if (formContainer.contains(formActions)) {
          formContainer.removeChild(formActions);
        }

        // Remove all fields
        if (formContainer.contains(sourceUrlGroup))
          formContainer.removeChild(sourceUrlGroup);
        if (formContainer.contains(tagsGroup))
          formContainer.removeChild(tagsGroup);
        if (formContainer.contains(notesGroup))
          formContainer.removeChild(notesGroup);

        // Re-add fields in the preferred order
        preferences.fieldOrder.forEach((field) => {
          if (field === "sourceUrl" && sourceUrlGroup) {
            formContainer.appendChild(sourceUrlGroup);
          } else if (field === "tags" && tagsGroup) {
            formContainer.appendChild(tagsGroup);
          } else if (field === "notes" && notesGroup) {
            formContainer.appendChild(notesGroup);
          }
        });

        // Add the action buttons back
        if (formActions) {
          formContainer.appendChild(formActions);
        }
      }

      // Update settings UI based on preferences
      function updateSettingsUI() {
        // Set active theme option
        document.querySelectorAll(".theme-option").forEach((option) => {
          option.classList.remove("active");
          if (option.dataset.value === preferences.theme) {
            option.classList.add("active");
          }
        });

        // Set active search action option
        document.querySelectorAll(".search-action-option").forEach((option) => {
          option.classList.remove("active");
          if (option.dataset.value === preferences.defaultSearchAction) {
            option.classList.add("active");
          }
        });

        document.getElementById("show-name-field").checked =
          preferences.searchFields.showName;

        document.getElementById("show-notes-field").checked =
          preferences.searchFields.showNotes;
        document.getElementById("show-tags-field").checked =
          preferences.searchFields.showTags;
        document.getElementById("show-url-field").checked =
          preferences.searchFields.showUrl;

        // Set autosave toggle
        document.getElementById("autosave-toggle").checked =
          preferences.autosave;

        // Apply field order
        setupFieldOrderDragAndDrop();
        initializeFieldOrder();
      }

      // Save preferences
      function savePreferences() {
        parent.postMessage(
          {
            pluginMessage: {
              type: "update-preferences",
              preferences,
            },
          },
          "*"
        );
      }

      // Update theme
      function updateTheme(theme) {
        if (theme === "dark") {
          document.body.classList.add("dark-theme");
        } else {
          document.body.classList.remove("dark-theme");
        }
      }

      // Update autosave
      function updateAutosave() {
        if (preferences.autosave) {
          document.getElementById("status-indicator").style.display = "flex";
        } else {
          document.getElementById("status-indicator").style.display = "none";

          // Clear any existing autosave timer
          if (autosaveTimer) {
            clearTimeout(autosaveTimer);
            autosaveTimer = null;
          }
        }
      }

      // Tag input handling
      function setupTagInput() {
        const tagInput = document.getElementById("tag-input");

        // Add tag on Enter
        tagInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && this.value.trim() !== "") {
            addTag(this.value.trim());
            this.value = "";
            e.preventDefault();
            autosaveDraft();
          }
        });

        // Show tag suggestions on input
        tagInput.addEventListener("input", function () {
          showTagSuggestions(this.value.trim());
        });

        // Hide suggestions on blur
        tagInput.addEventListener("blur", function () {
          setTimeout(() => {
            document.getElementById("tag-suggestions").style.display = "none";
          }, 200);
        });

        // Add tag button
        document
          .getElementById("add-tag-button")
          .addEventListener("click", function () {
            const tagInput = document.getElementById("tag-input");
            if (tagInput.value.trim() !== "") {
              addTag(tagInput.value.trim());
              tagInput.value = "";
              tagInput.focus();
              autosaveDraft();
            }
          });
      }

      // Show tag suggestions
      function showTagSuggestions(query) {
        const container = document.getElementById("tag-suggestions");

        // Clear previous suggestions
        container.innerHTML = "";

        if (!query || query.length < 1) {
          container.style.display = "none";
          return;
        }

        // Filter tags based on query
        const filteredTags = allTags.filter(
          (tag) =>
            tag.tag.toLowerCase().includes(query.toLowerCase()) &&
            !currentTags.includes(tag.tag)
        );

        if (filteredTags.length === 0) {
          container.style.display = "none";
          return;
        }

        // Create suggestion items
        filteredTags.slice(0, 5).forEach((tag) => {
          const item = document.createElement("div");
          item.className = "tag-suggestion-item";

          const tagName = document.createElement("span");
          tagName.textContent = tag.tag;

          const tagCount = document.createElement("span");
          tagCount.className = "tag-count";
          tagCount.textContent = tag.count;

          item.appendChild(tagName);
          item.appendChild(tagCount);

          item.addEventListener("click", () => {
            addTag(tag.tag);
            document.getElementById("tag-input").value = "";
            container.style.display = "none";
            autosaveDraft();
          });

          container.appendChild(item);
        });

        container.style.display = "block";
      }

      // Add tag
      function addTag(tag) {
        if (!currentTags.includes(tag)) {
          currentTags.push(tag);
          updateTagsDisplay();
        }
      }

      // Remove tag
      function removeTag(tag) {
        currentTags = currentTags.filter((t) => t !== tag);
        updateTagsDisplay();
        autosaveDraft();
      }

      // Update tags display
      function updateTagsDisplay() {
        const container = document.getElementById("tags-container");
        container.innerHTML = "";

        if (currentTags.length === 0) {
          return;
        }

        currentTags.forEach((tag) => {
          const tagElement = document.createElement("div");
          tagElement.className = "tag";

          const tagText = document.createElement("span");
          tagText.textContent = tag;

          const removeButton = document.createElement("span");
          removeButton.className = "tag-remove";
          removeButton.innerHTML =
            '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

          removeButton.addEventListener("click", () => {
            removeTag(tag);
          });

          tagElement.appendChild(tagText);
          tagElement.appendChild(removeButton);
          container.appendChild(tagElement);
        });
      }

      // URL field handling
      function setupUrlField() {
        const sourceUrl = document.getElementById("source-url");

        sourceUrl.addEventListener("input", function () {
          const url = this.value.trim();
          const openLinkBtn = document.getElementById("open-link-button");
          const copyLinkBtn = document.getElementById("copy-link-button");

          if (url) {
            openLinkBtn.style.display = "flex";
            copyLinkBtn.style.display = "flex";
          } else {
            openLinkBtn.style.display = "none";
            copyLinkBtn.style.display = "none";
          }

          autosaveDraft();
        });

        // Open link button
        document
          .getElementById("open-link-button")
          .addEventListener("click", function () {
            const url = document.getElementById("source-url").value.trim();
            if (url) {
              window.open(url, "_blank");
            }
          });

        // Copy link button
        document
          .getElementById("copy-link-button")
          .addEventListener("click", function () {
            const url = document.getElementById("source-url").value.trim();
            if (url) {
              navigator.clipboard.writeText(url).then(() => {
                showNotification("URL copied to clipboard");
              });
            }
          });

        // Notes field
        document.getElementById("notes").addEventListener("input", function () {
          autosaveDraft();
        });
      }

      // Form actions setup
      function setupFormActions() {
        // Save button
        document
          .getElementById("save-button")
          .addEventListener("click", function () {
            saveMetadata();
          });

        // Go to layer button
        document
          .getElementById("go-to-layer-button")
          .addEventListener("click", function () {
            if (currentNodeId) {
              console.log("Navigating to layer:", currentNodeId);
              navigateToElement(currentNodeId);
            } else {
              console.log("No node ID available for navigation");
              showNotification("No layer selected", "info");
            }
          });

        // Clear button
        document
          .getElementById("clear-button")
          .addEventListener("click", function () {
            if (
              confirm(
                "Are you sure you want to clear all content and delete this Asterisk?"
              )
            ) {
              // Check if it's an existing asterisk
              const isExisting = !!currentNodeId;

              // Clear form
              clearForm();

              // Delete the asterisk if it exists
              if (isExisting) {
                deleteAsterisk(currentNodeId);
              }
            }
          });
      }

      // Full updated setupPluginMessageListener function
      function setupPluginMessageListener() {
        window.onmessage = (event) => {
          const msg = event.data.pluginMessage;

          if (!msg) return;

          switch (msg.type) {
            case "init-preferences":
              preferences = msg.preferences;

              // Add new properties if they don't exist (for users with existing preferences)
              if (preferences.defaultSearchAction === undefined) {
                preferences.defaultSearchAction = "navigate";
              }

              if (preferences.fieldOrder === undefined) {
                preferences.fieldOrder = ["sourceUrl", "tags", "notes"];
              }

              if (preferences.searchFields === undefined) {
                preferences.searchFields = {
                  showName: true,
                  showNotes: true,
                  showTags: true,
                  showUrl: false,
                };
              }

              updateTheme(preferences.theme);
              updateAutosave();
              updateSettingsUI();
              break;

            case "context-info":
            case "context-changed":
              // Store file context info
              currentFileContext = {
                fileKey: msg.fileKey,
                pageId: msg.pageId,
                pageName: msg.pageName,
                timestamp: Date.now(),
              };

              console.log(
                `[STRICT] Context set to file="${msg.fileKey}", page="${msg.pageName}"`
              );

              // Reset all filter state
              activeFilterTags = [];
              allTags = [];
              allElements = [];

              // Request fresh data with current context
              parent.postMessage(
                { pluginMessage: { type: "get-all-tags" } },
                "*"
              );
              parent.postMessage(
                { pluginMessage: { type: "get-all-elements" } },
                "*"
              );

              // If in search tab, update UI
              if (activeTab === "search") {
                // Clear active filter buttons
                document.querySelectorAll(".filter-tag").forEach((tag) => {
                  tag.classList.remove("active");
                });

                // Show loading state
                const searchStatus = document.getElementById("search-status");
                if (searchStatus) {
                  searchStatus.textContent = `Loading data from "${msg.pageName}"...`;
                }

                // Clear search input
                document.getElementById("search-input").value = "";

                // Show loading state
                const asteriskList = document.getElementById("asterisk-list");
                asteriskList.innerHTML =
                  '<div style="text-align: center; padding: 20px;">Loading...</div>';
              }
              break;

            case "metadata-loaded":
              displayMetadata(msg.data);
              updateLayerInfo(msg.nodeName, msg.nodeId);
              showLayerSelected();
              break;

            case "draft-loaded":
              displayMetadata(msg.data);
              updateLayerInfo(msg.nodeName, msg.nodeId);
              showDraftStatus();
              showLayerSelected();
              break;

            case "new-element":
              clearForm();
              updateLayerInfo(msg.nodeName, msg.nodeId);
              showLayerSelected();
              break;

            case "no-selection":
              clearForm();
              showSelectLayer();
              break;

            case "selection-changed":
              parent.postMessage(
                { pluginMessage: { type: "get-metadata" } },
                "*"
              );
              break;

            case "all-tags":
              console.log(
                `[STRICT] Received ${
                  msg.tags?.length || 0
                } tags for file context:`,
                msg._debug || "unknown"
              );

              // STRICT VERIFICATION: Only accept tag data for current file context
              if (
                msg._debug &&
                msg._debug.fileKey !== currentFileContext.fileKey
              ) {
                console.log(
                  `[STRICT] REJECTED tags - wrong file (got ${msg._debug.fileKey}, expected ${currentFileContext.fileKey})`
                );
                return;
              }

              // Update tags array
              allTags = msg.tags || [];

              // Log each tag for debugging
              if (allTags.length > 0) {
                console.log(
                  "[STRICT] Tags received:",
                  allTags.map((t) => `${t.tag} (${t.count})`).join(", ")
                );
              } else {
                console.log("[STRICT] No tags found for this file/page");
              }

              // Update the UI
              updateFilterTags();
              if (activeTab === "search") {
                toggleEmptySearch();
              }
              break;

            case "all-elements":
              console.log(
                `[STRICT] Received ${
                  msg.elements?.length || 0
                } elements for file context:`,
                msg._debug || "unknown"
              );

              // STRICT VERIFICATION: Only accept element data for current file context
              if (
                msg._debug &&
                msg._debug.fileKey !== currentFileContext.fileKey
              ) {
                console.log(
                  `[STRICT] REJECTED elements - wrong file (got ${msg._debug.fileKey}, expected ${currentFileContext.fileKey})`
                );
                return;
              }

              // Update elements array
              allElements = msg.elements || [];

              // Update the UI
              renderElementsList();
              toggleEmptySearch();

              // Update search status
              const searchStatus = document.getElementById("search-status");
              if (searchStatus && activeTab === "search") {
                searchStatus.textContent =
                  allElements.length > 0
                    ? `Showing ${allElements.length} Asterisks in "${currentFileContext.pageName}"`
                    : `No Asterisks in "${currentFileContext.pageName}"`;
              }
              break;

            // Keep any other case handlers you already have
            default:
              // Handle any other message types as before
              break;
          }
        };
      }

      // Update layer info
      function updateLayerInfo(nodeName, nodeId) {
        currentNodeName = nodeName;
        currentNodeId = nodeId;

        document.getElementById("layer-name").textContent = nodeName;
      }

      // Display metadata
      function displayMetadata(data) {
        const sourceUrl = data.sourceUrl || "";
        const notes = data.notes || "";

        document.getElementById("source-url").value = sourceUrl;
        document.getElementById("notes").value = notes;

        // Update URL button visibility
        const openLinkBtn = document.getElementById("open-link-button");
        const copyLinkBtn = document.getElementById("copy-link-button");

        if (sourceUrl) {
          openLinkBtn.style.display = "flex";
          copyLinkBtn.style.display = "flex";
        } else {
          openLinkBtn.style.display = "none";
          copyLinkBtn.style.display = "none";
        }

        // Update tags
        currentTags = data.tags || [];
        updateTagsDisplay();
      }

      // Clear form
      function clearForm() {
        document.getElementById("source-url").value = "";
        document.getElementById("notes").value = "";
        document.getElementById("open-link-button").style.display = "none";
        document.getElementById("copy-link-button").style.display = "none";

        // Clear status indicators
        document.getElementById("status-indicator").style.display = "none";

        // Clear tags
        currentTags = [];
        updateTagsDisplay();
      }

      // Show layer selected state
      function showLayerSelected() {
        document.getElementById("layer-info").style.display = "flex";
        document.getElementById("select-layer").style.display = "none";
        document.getElementById("form-container").style.display = "block";
        document.getElementById("welcome-content").style.display = "none";
      }

      // Show select layer state
      function showSelectLayer() {
        document.getElementById("layer-info").style.display = "none";
        document.getElementById("select-layer").style.display = "flex";
        document.getElementById("form-container").style.display = "none";
        document.getElementById("welcome-content").style.display = "flex";

        // Clear the current node ID
        currentNodeId = "";
      }

      // Show draft status
      function showDraftStatus() {
        if (preferences.autosave) {
          document.getElementById("status-indicator").style.display = "flex";
        }
      }

      // Delete an Asterisk
      function deleteAsterisk(nodeId) {
        parent.postMessage(
          {
            pluginMessage: {
              type: "delete-asterisk",
              nodeId: nodeId,
            },
          },
          "*"
        );

        showNotification("No content. Removed Asterisk", "warning");

        // Refresh the elements list if we're in search tab
        if (activeTab === "search") {
          parent.postMessage(
            {
              pluginMessage: { type: "get-all-elements" },
            },
            "*"
          );
        }
      }

      // Save metadata
      function saveMetadata() {
        // Get values from form
        const sourceUrl = document.getElementById("source-url").value.trim();
        const notes = document.getElementById("notes").value.trim();

        // Check if the note is empty
        const hasTags = currentTags.length > 0;
        const hasContent = sourceUrl !== "" || notes !== "" || hasTags;

        if (!hasContent && currentNodeId) {
          // If the note is empty and it's an existing note, delete it
          deleteAsterisk(currentNodeId);
          return;
        } else if (!hasContent) {
          // If it's a new note with no content, just show a message
          showNotification(
            "Cannot save empty note. Add some content first.",
            "info"
          );
          return;
        }

        // Regular save logic for non-empty notes
        parent.postMessage(
          {
            pluginMessage: {
              type: "save-metadata",
              sourceUrl,
              tags: currentTags,
              notes,
            },
          },
          "*"
        );

        // Hide draft indicator
        document.getElementById("status-indicator").style.display = "flex";

        // Show notification
        showNotification("Note saved successfully!", "success");

        // Refresh the elements list if we're in search tab
        if (activeTab === "search") {
          parent.postMessage(
            {
              pluginMessage: { type: "get-all-elements" },
            },
            "*"
          );
        }
      }

      // Autosave draft
      function autosaveDraft() {
        if (!currentNodeId || !preferences.autosave) return;

        // Clear any existing timer
        if (autosaveTimer) {
          clearTimeout(autosaveTimer);
        }

        // Set new timer to save after a short delay
        autosaveTimer = setTimeout(() => {
          // Get values from form
          const sourceUrl = document.getElementById("source-url").value.trim();
          const notes = document.getElementById("notes").value.trim();

          // Show status indicator
          document.getElementById("status-indicator").style.display = "flex";

          // Save directly
          parent.postMessage(
            {
              pluginMessage: {
                type: "save-metadata",
                sourceUrl,
                tags: currentTags,
                notes,
              },
            },
            "*"
          );
        }, 1000); // 1 second delay
      }

      // Show notification
      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        notification.textContent = message;

        // Remove all type classes first
        notification.classList.remove("success", "warning", "info");

        // Add the appropriate type class
        notification.classList.add(type);

        // Show the notification
        notification.classList.add("show");

        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      // Update filter tags in search tab
      // function updateFilterTags() {
      //   const filterContainer = document.getElementById("filter-tags");

      //   // Clear existing tags
      //   filterContainer.innerHTML = "";

      //   // Sort tags by count (primary) and then alphabetically (secondary)
      //   const sortedTags = [...allTags].sort((a, b) => {
      //     // First sort by count (descending)
      //     if (b.count !== a.count) {
      //       return b.count - a.count;
      //     }
      //     // Then sort alphabetically
      //     return a.tag.localeCompare(b.tag);
      //   });

      //   // Create filter tags from sorted tags
      //   sortedTags.forEach((tag) => {
      //     const filterTag = document.createElement("div");
      //     filterTag.className = "filter-tag";
      //     if (activeFilterTags.includes(tag.tag)) {
      //       filterTag.classList.add("active");
      //     }

      //     const tagName = document.createElement("span");
      //     tagName.textContent = tag.tag;

      //     const countBadge = document.createElement("span");
      //     countBadge.className = "filter-count";
      //     countBadge.textContent = tag.count;

      //     filterTag.appendChild(tagName);
      //     filterTag.appendChild(countBadge);

      //     filterTag.addEventListener("click", () => {
      //       toggleFilterTag(tag.tag);
      //     });

      //     filterContainer.appendChild(filterTag);
      //   });
      // }

      function updateFilterTags() {
        const filterContainer = document.getElementById("filter-tags");

        // Clear existing tags
        filterContainer.innerHTML = "";

        console.log(
          `[STRICT] Updating filter tags UI with ${allTags.length} tags for file="${currentFileContext.fileKey}", page="${currentFileContext.pageName}"`
        );

        // No tags? Show a message
        if (!allTags || allTags.length === 0) {
          const noTagsMsg = document.createElement("div");
          noTagsMsg.textContent = `No tags in "${currentFileContext.pageName}"`;
          noTagsMsg.style.color = "var(--text-secondary)";
          noTagsMsg.style.padding = "10px 0";
          noTagsMsg.style.fontStyle = "italic";
          filterContainer.appendChild(noTagsMsg);
          return;
        }

        // Create filter tags
        allTags.forEach((tag) => {
          // EXTRA VERIFICATION: Only include tags from current file
          if (tag._fileKey && tag._fileKey !== currentFileContext.fileKey) {
            console.log(
              `[STRICT] Skipping tag "${tag.tag}" from wrong file ${tag._fileKey}`
            );
            return;
          }

          const filterTag = document.createElement("div");
          filterTag.className = "filter-tag";
          if (activeFilterTags.includes(tag.tag)) {
            filterTag.classList.add("active");
          }

          const tagName = document.createElement("span");
          tagName.textContent = tag.tag;

          const countBadge = document.createElement("span");
          countBadge.className = "filter-count";
          countBadge.textContent = tag.count;

          filterTag.appendChild(tagName);
          filterTag.appendChild(countBadge);

          filterTag.addEventListener("click", () => {
            toggleFilterTag(tag.tag);
          });

          filterContainer.appendChild(filterTag);
        });
      }

      // Full updated filterElements function
      function filterElements() {
        const searchQuery = document
          .getElementById("search-input")
          .value.toLowerCase();

        // Filter elements based on tags and search query and ensure they're from current file
        let filteredElements = allElements;

        // Verify all elements are from current file
        filteredElements = filteredElements.filter((element) => {
          return (
            !element._fileKey || element._fileKey === currentFileContext.fileKey
          );
        });

        if (activeFilterTags.length > 0) {
          filteredElements = filteredElements.filter((element) => {
            return activeFilterTags.every((tag) => element.tags.includes(tag));
          });
        }

        if (searchQuery) {
          filteredElements = filteredElements.filter((element) => {
            return (
              element.nodeName.toLowerCase().includes(searchQuery) ||
              (element.sourceUrl &&
                element.sourceUrl.toLowerCase().includes(searchQuery)) ||
              element.tags.some((tag) =>
                tag.toLowerCase().includes(searchQuery)
              ) ||
              (element.notes &&
                element.notes.toLowerCase().includes(searchQuery))
            );
          });
        }

        // Render filtered elements
        renderElementsList(filteredElements);

        // Update search status
        updateSearchStatus(filteredElements.length);
      }

      // Toggle filter tag
      function toggleFilterTag(tag) {
        if (activeFilterTags.includes(tag)) {
          activeFilterTags = activeFilterTags.filter((t) => t !== tag);
        } else {
          activeFilterTags.push(tag);
        }

        // Update UI
        document.querySelectorAll(".filter-tag").forEach((el) => {
          if (el.querySelector("span").textContent === tag) {
            el.classList.toggle("active");
          }
        });

        // Filter elements
        filterElements();
      }

      // Filter elements based on active filter tags and search query
      function filterElements() {
        const searchQuery = document
          .getElementById("search-input")
          .value.toLowerCase();

        // Filter elements based on tags and search query
        let filteredElements = allElements;

        if (activeFilterTags.length > 0) {
          filteredElements = filteredElements.filter((element) => {
            return activeFilterTags.every((tag) => element.tags.includes(tag));
          });
        }

        if (searchQuery) {
          filteredElements = filteredElements.filter((element) => {
            return (
              element.nodeName.toLowerCase().includes(searchQuery) ||
              (element.sourceUrl &&
                element.sourceUrl.toLowerCase().includes(searchQuery)) ||
              element.tags.some((tag) =>
                tag.toLowerCase().includes(searchQuery)
              ) ||
              (element.notes &&
                element.notes.toLowerCase().includes(searchQuery))
            );
          });
        }

        // Render filtered elements
        renderElementsList(filteredElements);

        // Update search status
        updateSearchStatus(filteredElements.length);
      }

      // Update search status
      function updateSearchStatus(count) {
        const searchStatus = document.getElementById("search-status");

        if (activeFilterTags.length > 0) {
          const tagNames = activeFilterTags.join('", "');
          searchStatus.textContent = `Showing ${count} Asterisks including "${tagNames}"`;
        } else {
          searchStatus.textContent = `Showing all Asterisks`;
        }
      }

      // Render elements list in search tab
      function renderElementsList(filteredElements = null) {
        const elements = filteredElements || allElements;
        const elementsList = document.getElementById("asterisk-list");

        // Clear existing list
        elementsList.innerHTML = "";
        void elementsList.offsetWidth; // Force reflow

        console.log("Rendering elements list:", elements.length, "items");

        if (elements.length === 0) {
          console.log("No elements to display");
          return;
        }

        // Create elements list items
        elements.forEach((element) => {
          const listItem = document.createElement("div");
          listItem.className = "asterisk-item";

          // Element content
          const content = document.createElement("div");
          content.className = "asterisk-content";

          // Check if at least one field is visible (to prevent empty rows)
          const anyFieldVisible =
            preferences.searchFields.showName ||
            (preferences.searchFields.showNotes && element.notes) ||
            (preferences.searchFields.showUrl && element.sourceUrl) ||
            (preferences.searchFields.showTags && element.tags.length > 0);

          // If all fields are hidden, show the name anyway
          const forceName = !anyFieldVisible;

          // Name field (conditional but forced if nothing else is shown)
          if (preferences.searchFields.showName || forceName) {
            const name = document.createElement("div");
            name.className = "asterisk-name";
            name.textContent = element.nodeName;
            content.appendChild(name);
          }

          // Notes field (conditional)
          if (preferences.searchFields.showNotes && element.notes) {
            const meta = document.createElement("div");
            meta.className = "asterisk-meta";
            meta.textContent = element.notes.substring(0, 60);
            content.appendChild(meta);
          }

          // URL field (conditional)
          if (preferences.searchFields.showUrl && element.sourceUrl) {
            const url = document.createElement("div");
            url.className = "asterisk-url xasterisk-meta";
            url.textContent = element.sourceUrl;
            content.appendChild(url);
          }

          // Tags field (conditional)
          if (preferences.searchFields.showTags && element.tags.length > 0) {
            const tags = document.createElement("div");
            tags.className = "asterisk-tags";

            // Add up to 3 tags
            element.tags.slice(0, 3).forEach((tag) => {
              const tagElement = document.createElement("span");
              tagElement.className = "asterisk-tag";
              tagElement.textContent = tag;
              tags.appendChild(tagElement);
            });

            if (element.tags.length > 3) {
              const moreTag = document.createElement("span");
              moreTag.className = "asterisk-tag";
              moreTag.textContent = `+${element.tags.length - 3}`;
              tags.appendChild(moreTag);
            }

            content.appendChild(tags);
          }

          // Action buttons container
          const actionButtons = document.createElement("div");
          actionButtons.className = "action-buttons-container";

          // Edit button (opens Add Asterisk tab)
          const editButton = document.createElement("button");
          editButton.className = "icon-btn tooltip tooltip-left";
          editButton.setAttribute("data-tooltip", "Open Asterisk");
          editButton.innerHTML =
            '<svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"> <g clip-path="url(#clip0_38_125)"> <path d="M9.07137 19.7287L8.82789 12.0348L2.54615 16.2713L0.306152 11.9374L7.41572 9.35654L1.52354 4.77915L4.98094 1.32176L9.55833 7.21393L12.1392 0.10437L16.5218 2.34437L12.2366 8.62611L19.9305 8.86959L19.1514 13.6905L11.7983 11.5478L13.9409 18.9496L9.07137 19.7287Z" fill="#7E6F5D"/></g><defs><clipPath id="clip0_38_125"><rect width="20" height="20" fill="white"/></clipPath></defs></svg>';

          editButton.addEventListener("click", (e) => {
            e.stopPropagation(); // Prevent triggering the parent click
            openEditAsterisk(element.nodeId);
          });

          // Go to layer button
          const goToButton = document.createElement("button");
          goToButton.className = "icon-btn tooltip tooltip-right";
          goToButton.setAttribute("data-tooltip", "Go to layer");
          goToButton.innerHTML =
            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3L20 9L12 15C12 14.1 12 12.2 12 11.2727C8.88642 10.8644 5.70793 10.6258 3.07089 12.6385C2.96589 12.7278 2.86089 12.8171 2.75271 12.9091C2.51083 13.1116 2.51083 13.1116 2.26407 13.3182C1.47998 14 0.590213 15.8757 0.207254 17.4545C0.147254 17.4545 0.0872543 17.4545 0.0254361 17.4545C-0.122715 14.9401 0.354838 12.8414 2.02544 10.9091C4.65424 8.00332 8.23599 6.94357 12 6.54545C12 6.54545 12 3.90909 12 3Z" fill="#7E6F5D"/><path d="M0.661749 13.0909C1.02539 13.6364 0.934498 13.6364 1.11632 14C1.29632 14 1.47632 14 1.66177 14C1.58724 14.1427 1.51271 14.2855 1.43592 14.4325C0.925534 15.4277 0.389107 16.6364 0.116379 17.9091C0.0563795 17.9091 0.0254489 17.5455 0.0254489 17.5455C-0.0413536 15.9892 0.163608 14.5705 0.661749 13.0909Z" fill="#759481"/></svg>';
          goToButton.addEventListener("click", (e) => {
            e.stopPropagation(); // Prevent triggering the parent click
            navigateToElement(element.nodeId);
          });

          actionButtons.appendChild(editButton);
          actionButtons.appendChild(goToButton);

          // Add event listener to the whole item to select it
          listItem.addEventListener("click", () => {
            // Use the default action based on user preferences
            if (preferences.defaultSearchAction === "navigate") {
              navigateToElement(element.nodeId);
            } else {
              openEditAsterisk(element.nodeId);
            }
          });

          listItem.appendChild(content);
          listItem.appendChild(actionButtons);
          elementsList.appendChild(listItem);
        });

        // Set up search functionality
        setupSearch();
      }

      // Function to open element in Edit tab
      function openEditAsterisk(nodeId) {
        // Switch to Add Asterisk tab
        switchTab("add");

        // Request the element metadata
        parent.postMessage(
          {
            pluginMessage: {
              type: "edit-element",
              nodeId: nodeId,
              selectNode: true, // This is the key addition AND select the node
            },
          },
          "*"
        );
      }

      // Setup search functionality
      function setupSearch() {
        const searchInput = document.getElementById("search-input");

        // Only add event listener if it doesn't already have one
        if (!searchInput.hasSearchListener) {
          searchInput.addEventListener("input", filterElements);
          searchInput.hasSearchListener = true;
        }
      }

      // Navigate to element in Figma
      function navigateToElement(nodeId) {
        console.log("Sending navigate message for node:", nodeId);
        parent.postMessage(
          {
            pluginMessage: {
              type: "navigate-to-node",
              nodeId: nodeId,
            },
          },
          "*"
        );
      }

      // Toggle empty search state
      // function toggleEmptySearch() {
      //   const emptyState = document.getElementById("empty-search");
      //   const searchContent = document.getElementById("search-content");

      //   if (!allElements || allElements.length === 0) {
      //     emptyState.style.display = "flex";
      //     searchContent.style.display = "none";
      //     console.log("Showing empty state");
      //   } else {
      //     emptyState.style.display = "none";
      //     searchContent.style.display = "block";
      //     console.log(
      //       "Showing search content with",
      //       allElements.length,
      //       "elements"
      //     );
      //   }
      // }

      function toggleEmptySearch() {
        const emptyState = document.getElementById("empty-search");
        const searchContent = document.getElementById("search-content");

        if (!allElements || allElements.length === 0) {
          emptyState.style.display = "flex";
          searchContent.style.display = "none";
          console.log(
            `[STRICT] Showing empty state for file="${currentFileContext.fileKey}"`
          );
        } else {
          emptyState.style.display = "none";
          searchContent.style.display = "block";
          console.log(
            `[STRICT] Showing search content with ${allElements.length} elements for file="${currentFileContext.fileKey}"`
          );
        }
      }

      // Setup resize handle
      function setupResizeHandle() {
        const resizeHandle = document.getElementById("resize-handle");
        let isResizing = false;
        let startWidth, startHeight;

        const startResize = (e) => {
          isResizing = true;
          startWidth = window.innerWidth;
          startHeight = window.innerHeight;
          document.addEventListener("mousemove", resize);
          document.addEventListener("mouseup", stopResize);
          e.preventDefault();
        };

        const resize = (e) => {
          if (!isResizing) return;

          const newWidth = startWidth + (e.clientX - startWidth);
          const newHeight = startHeight + (e.clientY - startHeight);

          // Minimum size constraints
          const width = Math.max(350, newWidth);
          const height = Math.max(500, newHeight);

          // Tell the plugin to resize
          parent.postMessage(
            {
              pluginMessage: {
                type: "resize",
                width,
                height,
              },
            },
            "*"
          );
        };

        const stopResize = () => {
          isResizing = false;
          document.removeEventListener("mousemove", resize);
          document.removeEventListener("mouseup", stopResize);
        };

        resizeHandle.addEventListener("mousedown", startResize);
      }

      // Setup keyboard shortcuts
      function setupKeyboardShortcuts() {
        document.addEventListener("keydown", function (e) {
          // Save with Ctrl/Cmd+S
          if ((e.ctrlKey || e.metaKey) && e.key === "s" && currentNodeId) {
            e.preventDefault();
            saveMetadata();
          }

          // Clear form with Escape key
          if (
            e.key === "Escape" &&
            activeTab === "add" &&
            document.getElementById("form-container").style.display !== "none"
          ) {
            e.preventDefault();

            if (confirm("Are you sure you want to clear all content?")) {
              const isExisting = !!currentNodeId;
              clearForm();

              if (isExisting) {
                deleteAsterisk(currentNodeId);
              }
            }
          }
        });
      }
    </script>
    <script src="script.js"></script>
  </body>
</html>
